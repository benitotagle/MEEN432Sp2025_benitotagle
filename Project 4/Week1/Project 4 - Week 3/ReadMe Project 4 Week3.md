To run the simulation, make sure that the Simulink model titled "Project4\_Simulink" is located in the current MATLAB working directory or within the MATLAB path. After confirming the model is there, run the MATLAB script named "Project4\_main". This script initializes the necessary vehicle, battery, and environment parameters, generates the track geometry, runs the Simulink model, and animates the vehicle path based on simulation outputs.

The Simulink model is divided into three main subsystems: Driver, Lateral Dynamics, and Longitudinal Dynamics. The Lateral Dynamics subsystem performs a relatively straightforward simulation. It begins by calculating the tire slip angles, which are then used to estimate the lateral forces at the front and rear tires. These forces contribute to the lateral acceleration of the vehicle, which is subsequently integrated to obtain the lateral velocity and the vehicle's orientation angle (psi).

The Longitudinal Dynamics subsystem is more complicated and includes several nested blocks such as the battery & motor, energy management, driveline, and wheels subfunctions. The process begins in the battery and motor subfunction, where the available electrical power is determined based on the current state of charge. This power is then used to compute the available mechanical torque at the motor shaft, which is limited by a predefined motor torque-speed curve. The resulting motor torque is passed to the Driver subsystem, which determines whether the torque request corresponds to propulsion or braking.

The output torque from the Driver subsystem is then fed into the Driveline subfunction, which models a single-stage gearbox. The motor torque, along with the shaft speed, is used by the Energy Management block to compute the instantaneous power consumption. This power is integrated over time to obtain the cumulative energy usage, which updates the battery's state of charge. The torque output from the gearbox, combined with any braking torque, is sent to the wheels subfunction. Here, the total torque is converted into longitudinal force at the wheels.

This longitudinal force is opposed by two forms of drag: rolling resistance and aerodynamic drag. The net force is used to compute the longitudinal acceleration of the vehicle, which is then integrated to yield the forward velocity and position.

The Driver sub function in the Simulink model is responsible for computing both the steering angle and the longitudinal torque demand to follow a reference path and desired velocity profile. It combines two primary control strategies: a pure pursuit lateral controller and a predictive longitudinal velocity controller based on PID logic. The function takes in current vehicle state (position, heading, and speed), track waypoints, and vehicle dynamics limits to compute the front steering angle and determine whether to apply motor torque or braking torque.

Lateral control is handled using a geometric Pure Pursuit approach. A lookahead point on the path is selected a fixed distance ahead of the current vehicle position in the direction of travel. This lookahead point is transformed into the vehicle’s local coordinate frame, and a circular arc is fit to it. The steering angle required to follow this arc is calculated based on the curvature of the arc and the vehicle’s wheelbase.

Longitudinal control is based on a predictive velocity planning strategy. A "predictive pose" is generated by projecting the vehicle's current position forward in time based on the current speed and heading. The lateral controller is then applied to this projected pose to estimate the steering angle of the coming path. Using the predictive steering angle instead of the track curvature allows the controller to react when the pure pursuit controller is adjustring course in straight lines, this allows the car to brake slightly not only in corners but in straight line steering corrections too. Using this curvature and the vehicle’s maximum lateral acceleration limit (derived from available tire force), the model calculates the reference velocity needed to stay within the tire force limits during cornering. On straight segments of the track, this reference velocity defaults to a predefined maximum target velocity calculated from the max RPMs and wheel radius.

The difference between the current velocity and the reference velocity is fed into a PID controller, which outputs a normalized command between \-1 and 1\. This command, referred to as alpha\_driver, is scaled by the instantaneous available motor torque or brake torque depending on whether the vehicle needs to accelerate or decelerate. The instantaneous available motor torque is derived from the battery & motor subfunctions.

In the case of deceleration, the function splits braking demand between regenerative braking and friction braking, based on a speed-dependent fit. The vehicle uses 100% friction braking when traveling under 5 mph. This friction contribution decreases linearly to 5% by the time the vehicle reaches 25 mph and remains constant beyond that point. The remainder of the braking torque is handled by regenerative braking through the motor, capped at 60% of its peak torque capability. 

The controller was tuned in multiple stages. Initial tuning was performed using steady-state step inputs to ensure the vehicle responded promptly and stably to basic velocity changes. It was then refined using standard EPA driving cycles, where the lateral dynamics were not yet modeled. Finally, the controller was tuned using the completed model by analyzing the reference velocity, actual velocity, and control error plots. While some error persists during aggressive acceleration, this is largely due to the fact that reference speeds on straights sometimes exceed what the motor can physically deliver. The controller gets close to zero error during braking and cornering events, where accuracy is most important as the vehicle veers off track there. 

Finally the matlab code will output a simulation of the car in track, a velocity contour of the track and finally prints the number of laps completed, the times the vehicle veered off track as well as the percentage of time the vehicle stayed within the track.

